#!/bin/bash

echo "ðŸ” DIAGNÃ“STICO SPECKLE S3 DIRECT UPLOAD"
echo "========================================="

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to check command result
check_result() {
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}âœ… $1${NC}"
    else
        echo -e "${RED}âŒ $1${NC}"
    fi
}

echo ""
echo "1ï¸âƒ£ VERIFICANDO CONTENEDORES..."
docker-compose ps
check_result "Estado de contenedores"

echo ""
echo "2ï¸âƒ£ VERIFICANDO CONECTIVIDAD INTERNA MinIO..."
docker-compose exec -T speckle-server curl -s -I http://minio:9000/health/live | head -1
check_result "Conectividad interna MinIO"

echo ""
echo "3ï¸âƒ£ VERIFICANDO CONECTIVIDAD EXTERNA MinIO..."
curl -s -I https://datificabimcloud.dpdns.org/minio/health/live | head -1
check_result "Conectividad externa MinIO"

echo ""
echo "4ï¸âƒ£ VERIFICANDO BUCKET SPECKLE-SERVER..."
docker-compose exec -T speckle-server sh -c "
    curl -s -X HEAD \
    -H 'Authorization: AWS4-HMAC-SHA256 Credential=minioadmin/$(date +%Y%m%d)/us-east-1/s3/aws4_request, SignedHeaders=host;x-amz-date, Signature=dummy' \
    http://minio:9000/speckle-server/ | head -1
"
check_result "Bucket accesible"

echo ""
echo "5ï¸âƒ£ LOGS CRÃTICOS MinIO (Ãºltimas 20 lÃ­neas)..."
echo -e "${YELLOW}--- MinIO Logs ---${NC}"
docker-compose logs --tail=20 minio | grep -E "(ERROR|WARN|INFO.*CORS|started)"

echo ""
echo "6ï¸âƒ£ LOGS CRÃTICOS Speckle Server (S3/MinIO relacionados)..."
echo -e "${YELLOW}--- Speckle Server S3 Logs ---${NC}"
docker-compose logs speckle-server | grep -E "(S3|MinIO|BlobStorage|s3|minio)" | tail -20

echo ""
echo "7ï¸âƒ£ LOGS CRÃTICOS Create Bucket..."
echo -e "${YELLOW}--- Create Bucket Logs ---${NC}"
docker-compose logs create-bucket

echo ""
echo "8ï¸âƒ£ VERIFICANDO VARIABLES DE ENTORNO S3 EN SPECKLE SERVER..."
echo -e "${YELLOW}--- S3 Environment Variables ---${NC}"
docker-compose exec -T speckle-server printenv | grep -E "^S3_|^MINIO_" | sort

echo ""
echo "9ï¸âƒ£ VERIFICANDO VARIABLES DE ENTORNO S3 EN FRONTEND..."
echo -e "${YELLOW}--- Frontend S3 Environment Variables ---${NC}"
docker-compose exec -T speckle-frontend-2 printenv | grep -E "NUXT.*S3|NUXT.*UPLOAD" | sort

echo ""
echo "ðŸ”Ÿ TEST DE PRESIGNED URL (simulaciÃ³n)..."
echo -e "${YELLOW}--- Testing Presigned URL Generation ---${NC}"
docker-compose exec -T speckle-server node -e "
try {
  console.log('S3_ENDPOINT:', process.env.S3_ENDPOINT);
  console.log('S3_PUBLIC_ENDPOINT:', process.env.S3_PUBLIC_ENDPOINT);
  console.log('S3_DIRECT_UPLOAD_ENABLED:', process.env.S3_DIRECT_UPLOAD_ENABLED);
  console.log('FF_LEGACY_FILE_IMPORTS_ENABLED:', process.env.FF_LEGACY_FILE_IMPORTS_ENABLED);
} catch(e) {
  console.error('Error:', e.message);
}
"

echo ""
echo "1ï¸âƒ£1ï¸âƒ£ NGINX STATUS Y CONFIGURACIÃ“N..."
echo -e "${YELLOW}--- Nginx Status ---${NC}"
docker-compose exec -T nginx nginx -t
check_result "ConfiguraciÃ³n Nginx vÃ¡lida"

echo ""
echo "1ï¸âƒ£2ï¸âƒ£ TEST CORS MinIO..."
echo -e "${YELLOW}--- CORS Test ---${NC}"
curl -s -X OPTIONS \
  -H "Origin: https://datificabimcloud.dpdns.org" \
  -H "Access-Control-Request-Method: PUT" \
  -H "Access-Control-Request-Headers: content-type,authorization" \
  https://datificabimcloud.dpdns.org/minio/ | head -10

echo ""
echo "ðŸ“Š RESUMEN DEL DIAGNÃ“STICO"
echo "=========================="
echo -e "${YELLOW}Si ves errores arriba, estos son los problemas mÃ¡s comunes:${NC}"
echo ""
echo -e "${RED}âŒ Error de conectividad interna:${NC} MinIO no responde desde Speckle Server"
echo "   ðŸ‘‰ SoluciÃ³n: Verificar que MinIO estÃ© ejecutÃ¡ndose y sea accesible en puerto 9000"
echo ""
echo -e "${RED}âŒ Error de conectividad externa:${NC} MinIO no es accesible desde fuera"
echo "   ðŸ‘‰ SoluciÃ³n: Verificar nginx.conf y que el puerto 34355 estÃ© expuesto"
echo ""
echo -e "${RED}âŒ Error de CORS:${NC} No se ven headers Access-Control-*"
echo "   ðŸ‘‰ SoluciÃ³n: Verificar que cors.json se aplicÃ³ correctamente"
echo ""
echo -e "${RED}âŒ Error de variables de entorno:${NC} S3_PUBLIC_ENDPOINT vacÃ­o o incorrecto"
echo "   ðŸ‘‰ SoluciÃ³n: Verificar docker-compose.yml y reiniciar contenedores"
echo ""
echo -e "${GREEN}ðŸ“‹ Para probar la carga de archivos:${NC}"
echo "1. Ir a https://datificabimcloud.dpdns.org"
echo "2. Crear un proyecto"
echo "3. Intentar subir un archivo > 50MB"
echo "4. Revisar Network tab en DevTools del navegador"
echo ""
echo "ðŸ”„ Si hay problemas, ejecutar:"
echo "   docker-compose down && docker-compose up -d"
echo "   docker-compose logs -f speckle-server | grep -i s3"
