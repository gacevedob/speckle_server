events {
    worker_connections 1024;
}

http {
    # Upstreams
    upstream backend {
        server speckle-server:3000;
    }

    upstream frontend {
        server speckle-frontend-2:8080;
    }

    upstream preview {
        server preview-service:3001;
    }

    upstream minio_api {
        server minio:9000;
    }

    upstream minio_console {
        server minio:9001;
    }

    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    # Logs detallados
    log_format detailed '$remote_addr - $remote_user [$time_local] "$request" '
                       '$status $body_bytes_sent "$http_referer" '
                       '"$http_user_agent" "$upstream_addr" '
                       '"$http_x_forwarded_for" "$http_host" '
                       '"$request_time" "$upstream_response_time"';

    access_log /var/log/nginx/access.log detailed;
    error_log /var/log/nginx/error.log debug;

    server {
        listen 80;
        server_name datificabimcloud.dpdns.org;

        # Configuración global para archivos grandes
        client_max_body_size 1000M;
        client_body_buffer_size 128k;
        client_body_timeout 600s;
        client_header_timeout 600s;
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
        send_timeout 600s;
        
        # Desactivar buffering para uploads grandes
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_max_temp_file_size 0;

        # Headers globales por defecto
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $http_host;
        proxy_set_header X-Forwarded-Port 443;

        # Headers Cloudflare
        proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
        proxy_set_header CF-Ray $http_cf_ray;
        proxy_set_header CF-Visitor $http_cf_visitor;

        # CRÍTICO: Ruta para assets del bucket speckle-server
        # Esta es la ruta que genera S3 cuando se usa path-style
        location ~ ^/speckle-server/(.*)$ {
            # Proxy a MinIO API con la ruta correcta del bucket
            proxy_pass http://minio_api/speckle-server/$1$is_args$args;
            proxy_http_version 1.1;

            # Headers S3 críticos
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Forwarded-Host $http_host;
            proxy_set_header X-Forwarded-Port 443;
            
            # Preservar headers de autorización S3
            proxy_pass_request_headers on;
            proxy_set_header Authorization $http_authorization;

            # CORS completo para S3 API
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS, HEAD' always;
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,x-amz-*,content-md5,x-amz-content-sha256,x-amz-date,x-amz-security-token,x-amz-user-agent' always;
            add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range,ETag,x-amz-*,x-amz-request-id,x-amz-id-2' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;

            # Manejar preflight OPTIONS
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS, HEAD' always;
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,x-amz-*,content-md5,x-amz-content-sha256,x-amz-date,x-amz-security-token,x-amz-user-agent' always;
                add_header 'Access-Control-Max-Age' 1728000 always;
                add_header 'Content-Type' 'text/plain; charset=utf-8' always;
                add_header 'Content-Length' 0 always;
                return 204;
            }

            # Configuración para uploads grandes
            proxy_buffering off;
            proxy_request_buffering off;
            proxy_set_header Connection "";
            proxy_intercept_errors off;

            # Timeouts extendidos
            proxy_connect_timeout 600s;
            proxy_send_timeout 600s;
            proxy_read_timeout 600s;

            client_max_body_size 1000M;
            client_body_timeout 600s;
            
            # No reescribir redirects
            proxy_redirect off;
        }

        # MinIO API - Configuración para acceso directo /minio/
        location /minio/ {
            rewrite ^/minio/(.*)$ /$1 break;
            proxy_pass http://minio_api;
            proxy_http_version 1.1;

            # Headers críticos para MinIO
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Forwarded-Host $http_host;
            proxy_set_header X-Forwarded-Port 443;
            
            # Headers de autorización S3
            proxy_pass_request_headers on;
            proxy_set_header Authorization $http_authorization;

            # CORS completo
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS, HEAD' always;
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,x-amz-*,content-md5,x-amz-content-sha256,x-amz-date,x-amz-security-token,x-amz-user-agent' always;
            add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range,ETag,x-amz-*,x-amz-request-id,x-amz-id-2' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;

            # Manejar preflight OPTIONS
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS, HEAD' always;
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization,x-amz-*,content-md5,x-amz-content-sha256,x-amz-date,x-amz-security-token,x-amz-user-agent' always;
                add_header 'Access-Control-Max-Age' 1728000 always;
                add_header 'Content-Type' 'text/plain; charset=utf-8' always;
                add_header 'Content-Length' 0 always;
                return 204;
            }

            # Configuración para uploads grandes
            proxy_buffering off;
            proxy_request_buffering off;
            proxy_set_header Connection "";
            proxy_intercept_errors off;

            # Timeouts extendidos
            proxy_connect_timeout 600s;
            proxy_send_timeout 600s;
            proxy_read_timeout 600s;

            client_max_body_size 1000M;
            client_body_timeout 600s;
            
            proxy_redirect off;
        }

        # MinIO Console (interfaz web administrativa)
        location /minio-console/ {
            rewrite ^/minio-console/(.*) /$1 break;
            proxy_pass http://minio_console;
            proxy_http_version 1.1;
            
            # Headers estándar para la consola
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Forwarded-Host $http_host;
            proxy_set_header X-Forwarded-Port 443;
            
            # Soporte para WebSockets (consola MinIO)
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }
        
        # Previews (servicio de previsualizaciones)
        location /preview/ {
            proxy_pass http://preview/;
            proxy_http_version 1.1;
            
            # Headers estándar
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Forwarded-Host $http_host;
            proxy_set_header X-Forwarded-Port 443;
            proxy_redirect off;
        }

        # GraphQL con soporte para WebSockets y timeouts extendidos
        location /graphql {
            proxy_pass http://backend/graphql;
            proxy_http_version 1.1;
            
            # Soporte para WebSockets (suscripciones GraphQL)
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;

            # Headers estándar
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Forwarded-Host $http_host;
            proxy_set_header X-Forwarded-Port 443;

            # Timeouts específicos para operaciones GraphQL complejas
            proxy_connect_timeout 600s;
            proxy_send_timeout 600s;
            proxy_read_timeout 600s;
        }

        # Endpoints API del backend con configuración para uploads
        location /readiness { 
            proxy_pass http://backend/readiness;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Forwarded-Host $http_host;
            proxy_set_header X-Forwarded-Port 443;
        }
        
        location /api/ { 
            proxy_pass http://backend/api/;
            proxy_buffering off;
            proxy_request_buffering off;
            client_max_body_size 1000M;
            
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Forwarded-Host $http_host;
            proxy_set_header X-Forwarded-Port 443;
        }
        
        location /auth/ { 
            proxy_pass http://backend/auth/;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Forwarded-Host $http_host;
            proxy_set_header X-Forwarded-Port 443;
        }
        
        location /objects/ { 
            proxy_pass http://backend/objects/;
            proxy_buffering off;
            proxy_request_buffering off;
            client_max_body_size 1000M;
            
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Forwarded-Host $http_host;
            proxy_set_header X-Forwarded-Port 443;
        }
        
        location /streams/ { 
            proxy_pass http://backend/streams/;
            proxy_buffering off;
            proxy_request_buffering off;
            client_max_body_size 1000M;
            
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Forwarded-Host $http_host;
            proxy_set_header X-Forwarded-Port 443;
        }
        
        location /uploads/ { 
            proxy_pass http://backend/uploads/;
            proxy_buffering off;
            proxy_request_buffering off;
            client_max_body_size 1000M;

            # Headers estándar
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Forwarded-Host $http_host;
            proxy_set_header X-Forwarded-Port 443;

            # Timeouts extendidos para uploads grandes
            proxy_connect_timeout 600s;
            proxy_send_timeout 600s;
            proxy_read_timeout 600s;
        }

        # WebSockets para tiempo real
        location /ws {
            proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Forwarded-Host $http_host;
            proxy_set_header X-Forwarded-Port 443;
        }

        # Frontend (todo lo que no coincida con las rutas anteriores)
        location / {
            proxy_pass http://frontend/;
            proxy_http_version 1.1;
            
            # Soporte para WebSockets (hot reload en desarrollo)
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            proxy_set_header X-Forwarded-Host $http_host;
            proxy_set_header X-Forwarded-Port 443;
        }
    }
}
