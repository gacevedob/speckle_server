# name: 'speckle-server'

services:
  postgres:
    image: 'postgres:16.9-alpine'
    restart: always
    environment:
      POSTGRES_DB: speckle
      POSTGRES_USER: speckle
      POSTGRES_PASSWORD: speckle
    volumes:
      - ./postgres-data:/var/lib/postgresql/data/
    command: >
      postgres
      -c max_connections=200
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c work_mem=16MB
      -c maintenance_work_mem=256MB
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U speckle -d speckle"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - speckle-network

  redis:
    image: 'redis:8-alpine'
    restart: always
    volumes:
      - ./redis-data:/data
    command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s
    networks:
      - speckle-network

  minio:
    image: 'minio/minio'
    command: server /data --console-address ":9001" --address ":9000"
    restart: always
    mem_limit: 1g
    memswap_limit: 1g
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_BROWSER_REDIRECT_URL: "${MINIO_BROWSER_REDIRECT_URL:-https://datificabimcloud.dpdns.org/minio-console}"
      MINIO_REGION: "us-east-1"
      MINIO_API_CORS_ALLOW_ORIGIN: "*"
      MINIO_DOMAIN: "${MINIO_PUBLIC_HOSTNAME:-}"
      MINIO_SERVER_URL: "${MINIO_PUBLIC_HOSTNAME:+https://${MINIO_PUBLIC_HOSTNAME}}"
    volumes:
      - ./minio-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - speckle-network

  minio-init:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      S3_BUCKET: ${S3_BUCKET:-speckle-server}
      MINIO_SET_PUBLIC: ${MINIO_SET_PUBLIC:-true}
    volumes:
      - ./cors.json:/config/cors.json:ro
      - ./cors.xml:/config/cors.xml:ro
    entrypoint: >
      /bin/sh -c "
      set -euo pipefail;
      BUCKET=\"$${S3_BUCKET:-speckle-server}\";
      PUBLIC=\"$${MINIO_SET_PUBLIC:-true}\";
      CORS_FILE=\"\";
      if [ -f /config/cors.json ]; then
        CORS_FILE=/config/cors.json;
      elif [ -f /config/cors.xml ]; then
        CORS_FILE=/config/cors.xml;
      fi;
      echo 'Configuring MinIO bucket:' $BUCKET;
      mc alias set myminio http://minio:9000 $${MINIO_ROOT_USER} $${MINIO_ROOT_PASSWORD};
      mc mb myminio/${BUCKET} --ignore-existing;
      if [ \"$PUBLIC\" = \"true\" ]; then
        mc anonymous set download myminio/${BUCKET};
      fi;
      if [ -n \"$CORS_FILE\" ]; then
        mc cors set myminio/${BUCKET} $CORS_FILE;
      else
        echo 'No CORS file found, skipping CORS configuration';
      fi;
      mc cors list myminio/${BUCKET} || true;
      echo 'MinIO bucket configured successfully';
      "
    networks:
      - speckle-network

  speckle-server:
    image: speckle/speckle-server:2.26.8
    restart: always
    mem_limit: 2g
    memswap_limit: 2g
    healthcheck:
      test:
        - CMD
        - /nodejs/bin/node
        - -e
        - "try { require('node:http').request({headers: {'Content-Type': 'application/json'}, port:3000, hostname:'127.0.0.1', path:'/readiness', method: 'GET', timeout: 2000 }, (res) => { body = ''; res.on('data', (chunk) => {body += chunk;}); res.on('end', () => {process.exit(res.statusCode != 200 || body.toLowerCase().includes('error') ? 1 : 0);}); }).end(); } catch { process.exit(1); }"
      interval: 30s
      timeout: 15s
      retries: 3
      start_period: 120s
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    environment:
      - CANONICAL_URL=https://datificabimcloud.dpdns.org
      - FRONTEND_ORIGIN=https://datificabimcloud.dpdns.org
      - SESSION_SECRET=abcdefghijklmnopqrstuvwxyz1234567890
      - STRATEGY_LOCAL=true
      - LOG_LEVEL=debug
      - LOG_PRETTY=true
      - POSTGRES_URL=postgres
      - POSTGRES_USER=speckle
      - POSTGRES_PASSWORD=speckle
      - POSTGRES_DB=speckle
      - REDIS_URL=redis://redis
      - S3_ENDPOINT=http://minio:9000
      - S3_PUBLIC_ENDPOINT=${S3_PUBLIC_ENDPOINT:-https://datificabimcloud.dpdns.org}
      - S3_ACCESS_KEY=minioadmin
      - S3_SECRET_KEY=minioadmin
      - S3_BUCKET=speckle-server
      - S3_REGION=us-east-1
      - S3_CREATE_BUCKET=true
      - S3_FORCE_PATH_STYLE=true
      - S3_USE_SSL=false
      - S3_PUBLIC_USE_SSL=true
      - FILE_SIZE_LIMIT_MB=1024
      - UPLOAD_MULTIPART_CHUNK_SIZE_MB=50
      - FF_LEGACY_FILE_IMPORTS_ENABLED=false
      - NODE_OPTIONS=--max-old-space-size=1536
      - EMAIL=false
    networks:
      - speckle-network

  speckle-frontend-2:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    restart: always
    mem_limit: 512m
    healthcheck:
      test:
        - CMD-SHELL
        - /bin/sh
        - -c
        - >
          node -e "require('http').get('http://127.0.0.1:8080', res => { process.exit(res.statusCode >= 200 && res.statusCode < 500 ? 0 : 1); }).on('error', () => process.exit(1));"
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    environment:
      - NUXT_PUBLIC_SERVER_NAME=DataBIM Cloud
      - NUXT_PUBLIC_API_ORIGIN=https://datificabimcloud.dpdns.org
      - NUXT_PUBLIC_BASE_URL=https://datificabimcloud.dpdns.org
      - NUXT_PUBLIC_BACKEND_API_ORIGIN=http://speckle-server:3000
      - NUXT_PUBLIC_LOG_LEVEL=warn
      - NUXT_REDIS_URL=redis://redis
      - NUXT_PUBLIC_FF_LEGACY_FILE_IMPORTS_ENABLED=false
      - NUXT_PUBLIC_MAX_FILE_SIZE=1073741824
      - LOG_LEVEL=info
      - LOG_PRETTY=true
    depends_on:
      speckle-server:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - speckle-network

  preview-service:
    image: speckle/speckle-preview-service:2.26.8
    restart: always
    mem_limit: 1g
    environment:
      - LOG_LEVEL=info
      - LOG_PRETTY=true
      - REDIS_URL=redis://redis
      - PG_CONNECTION_STRING=postgres://speckle:speckle@postgres/speckle
      - SPECKLE_SERVER_URL=http://speckle-server:3000
      - PORT=3001
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - speckle-network

  webhook-service:
    image: speckle/speckle-webhook-service:2.26.8
    restart: always
    mem_limit: 256m
    environment:
      - LOG_LEVEL=info
      - LOG_PRETTY=true
      - PG_CONNECTION_STRING=postgres://speckle:speckle@postgres/speckle
    depends_on:
      speckle-server:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - speckle-network

  fileimport-service:
    image: speckle/speckle-fileimport-service:2.26.8
    restart: always
    mem_limit: 6g
    memswap_limit: 6g
    cpus: '4.0'
    environment:
      - SPECKLE_SERVER_URL=http://speckle-server:3000
      - LOG_LEVEL=debug
      - LOG_PRETTY=true
      - PG_CONNECTION_STRING=postgres://speckle:speckle@postgres/speckle
      - REDIS_URL=redis://redis
      - S3_ENDPOINT=http://minio:9000
      - S3_ACCESS_KEY=minioadmin
      - S3_SECRET_KEY=minioadmin
      - S3_BUCKET=speckle-server
      - S3_REGION=us-east-1
      - S3_FORCE_PATH_STYLE=true
      - S3_USE_SSL=false
      - S3_PUBLIC_USE_SSL=true
      - FILE_SIZE_LIMIT_MB=1024
      - IMPORT_TIME_LIMIT_MIN=180
      - NODE_OPTIONS=--max-old-space-size=4096
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s
    depends_on:
      speckle-server:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    networks:
      - speckle-network

  nginx:
    image: nginx:alpine
    restart: always
    mem_limit: 256m
    environment:
      - NGINX_ENABLE_CATCH_ALL=${NGINX_ENABLE_CATCH_ALL:-}
    depends_on:
      speckle-server:
        condition: service_healthy
      speckle-frontend-2:
        condition: service_healthy
      minio:
        condition: service_healthy
    ports:
      - "34355:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost/readiness || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 120s
    networks:
      - speckle-network

networks:
  speckle-network:
    driver: bridge
